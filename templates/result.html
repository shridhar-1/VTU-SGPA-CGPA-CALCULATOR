<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VTU CGPA Result Pro</title>
    
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        /* Exact Match to your Dark Theme */
        :root {
            --bg-deep: #0B0F19;
            --card-bg: #151C2C;
            --primary-blue: #3B82F6;
            --blue-glow: rgba(59, 130, 246, 0.4);
            --text-main: #FFFFFF;
            --text-muted: #8B949E;
            --border-color: #2D3748;
            --grade-o: #10B981; /* Neon Green */
            --grade-f: #EF4444; /* Neon Red */
        }

        html, body {
            margin: 0; padding: 0;
            background-color: var(--bg-deep);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, sans-serif;
            overscroll-behavior-y: none; /* Stops pull-to-refresh at the top */
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
            padding-bottom: 40px;
        }

        /* The Main Result Card */
        .result-card {
            background: var(--card-bg);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5);
        }

        /* Glowing CGPA Box */
        .cgpa-box {
            text-align: center;
            padding: 25px;
            border-radius: 16px;
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(11, 15, 25, 0.8));
            border: 1px solid var(--primary-blue);
            box-shadow: 0 0 20px var(--blue-glow);
            margin-bottom: 30px;
            position: relative;
            overflow: hidden;
        }

        .cgpa-title { 
            color: var(--primary-blue); 
            font-size: 13px; 
            text-transform: uppercase; 
            letter-spacing: 3px; 
            margin: 0 0 10px 0; 
            font-weight: bold;
        }
        
        .cgpa-value { 
            color: var(--text-main); 
            font-size: 55px; 
            font-weight: 900; 
            margin: 0; 
            text-shadow: 0 0 20px var(--blue-glow); 
            letter-spacing: -1px;
        }

        /* Semester Tables */
        .sem-title { 
            color: var(--text-main); 
            border-bottom: 1px solid var(--border-color); 
            padding-bottom: 12px; 
            margin-top: 35px; 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            font-size: 18px;
        }
        
        .sgpa-badge { 
            background: rgba(59, 130, 246, 0.2); 
            color: var(--primary-blue); 
            padding: 6px 14px; 
            border-radius: 20px; 
            font-size: 14px; 
            font-weight: 800; 
            border: 1px solid rgba(59, 130, 246, 0.4);
        }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; font-size: 14px; }
        th { text-align: left; padding: 12px 8px; color: var(--text-muted); border-bottom: 1px solid var(--border-color); font-weight: 600; text-transform: uppercase; font-size: 11px; letter-spacing: 1px;}
        td { padding: 14px 8px; border-bottom: 1px solid rgba(45, 55, 72, 0.3); font-weight: 500;}
        tr:last-child td { border-bottom: none; }
        
        .grade-O, .grade-S { color: var(--grade-o); font-weight: 800; text-shadow: 0 0 10px rgba(16, 185, 129, 0.4);}
        .grade-F { color: var(--grade-f); font-weight: 800; text-shadow: 0 0 10px rgba(239, 68, 68, 0.4);}

        /* Buttons */
        .action-buttons {
            display: flex; gap: 15px; margin-top: 40px;
        }
        .btn {
            flex: 1; padding: 16px; border-radius: 12px; font-weight: bold; font-size: 15px; cursor: pointer; border: none; display: flex; justify-content: center; align-items: center; gap: 10px; transition: 0.2s;
        }
        .btn-download { background: var(--primary-blue); color: white; box-shadow: 0 0 15px var(--blue-glow); }
        .btn-home { background: rgba(255, 255, 255, 0.05); border: 1px solid var(--border-color); color: var(--text-main); }
        .btn:active { transform: scale(0.96); }
    </style>
</head>
<body>
    <div class="container" id="pdf-content">
        <div class="result-card">
            
            <div class="cgpa-box">
                <p class="cgpa-title">Grand CGPA</p>
                <h1 class="cgpa-value">{{ data.cgpa }}</h1>
            </div>

            {% for sem in data.semesters %}
            <div class="sem-section">
                <h3 class="sem-title">
                    Semester {{ sem.semester }}
                    <span class="sgpa-badge">SGPA: {{ sem.sgpa }}</span>
                </h3>
                <table>
                    <thead>
                        <tr>
                            <th>Subject Code</th>
                            <th>Marks</th>
                            <th>Grade</th>
                            <th>Cr</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for sub in sem.subjects %}
                        <tr>
                            <td style="color: #9CA3AF;">{{ sub.code }}</td>
                            <td>{{ sub.marks }}</td>
                            <td class="{% if sub.grade == 'F' %}grade-F{% elif sub.grade == 'O' or sub.grade == 'S' %}grade-O{% else %}grade-A{% endif %}">{{ sub.grade }}</td>
                            <td style="color: #9CA3AF;">{{ sub.credits }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            {% endfor %}

        </div>
    </div>

    <div class="container" style="padding-top: 0;">
        <div class="action-buttons" id="action-btns">
            <button class="btn btn-home" onclick="window.location.href='/'">
                <i class="fa-solid fa-house"></i> Home
            </button>
            <button class="btn btn-download" onclick="downloadProPDF()">
                <i class="fa-solid fa-download"></i> Save PDF
            </button>
        </div>
    </div>

    <script>
        // 1. Android Back Button Trap
        // If they press the physical back button, it smoothly takes them to the home page!
        window.history.pushState({ page: 1 }, "", "");
        window.addEventListener("popstate", function(event) {
            window.location.href = '/';
        });

        // 2. The Pro PDF Downloader (Android App Wrapper Safe)
        function downloadProPDF() {
            const element = document.getElementById('pdf-content');
            const downloadBtn = document.querySelector('.btn-download');
            
            // Show loading state on button
            const originalText = downloadBtn.innerHTML;
            downloadBtn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Generating...';
            downloadBtn.style.pointerEvents = 'none';

            // PDF settings mapped for dark mode
            const opt = {
                margin: 0.2,
                filename: 'VTU_CGPA_Result_' + Math.floor(Date.now() / 1000) + '.pdf',
                image: { type: 'jpeg', quality: 1.0 },
                html2canvas: { 
                    scale: 2, 
                    useCORS: true, 
                    backgroundColor: '#0B0F19' // Forces the PDF to keep your beautiful dark theme!
                },
                jsPDF: { unit: 'in', format: 'a4', orientation: 'portrait' }
            };

            // Use the Data URI method to bypass broken Android App download managers
            html2pdf().set(opt).from(element).outputPdf('datauristring').then(function (pdfBase64) {
                // Instantly open the PDF in the phone's native viewer
                location.href = pdfBase64;
                
                // Restore button
                downloadBtn.innerHTML = originalText;
                downloadBtn.style.pointerEvents = 'auto';
            }).catch(err => {
                console.log("PDF Error: ", err);
                // Fallback to normal save if the URI bypass fails
                html2pdf().set(opt).from(element).save().then(() => {
                    downloadBtn.innerHTML = originalText;
                    downloadBtn.style.pointerEvents = 'auto';
                });
            });
        }
    </script>
</body>
</html>
